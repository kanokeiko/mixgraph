import React, { useState, useMemo } from 'react';
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from 'recharts';

const ProductCompositionChart = () => {
  const [dataSets, setDataSets] = useState([
    { name: 'A店', data: Array(5).fill().map(() => ({ amount: '', faces: '' })) },
    { name: 'B店', data: Array(5).fill().map(() => ({ amount: '', faces: '' })) },
    { name: 'C店', data: Array(5).fill().map(() => ({ amount: '', faces: '' })) },
  ]);

  const handleInputChange = (dataSetIndex, dataPointIndex, field, value) => {
    const newDataSets = [...dataSets];
    newDataSets[dataSetIndex].data[dataPointIndex][field] = value;
    setDataSets(newDataSets);
  };

  const handleDataSetNameChange = (dataSetIndex, newName) => {
    const newDataSets = [...dataSets];
    newDataSets[dataSetIndex].name = newName;
    setDataSets(newDataSets);
  };

  const processedData = useMemo(() => {
    const allPoints = dataSets.flatMap(dataSet => 
      dataSet.data
        .filter(point => point.amount !== '' && point.faces !== '')
        .map(point => ({
          amount: parseFloat(point.amount),
          [dataSet.name]: parseFloat(point.faces),
        }))
    );

    const sortedPoints = allPoints.sort((a, b) => a.amount - b.amount);
    const uniqueAmounts = Array.from(new Set(sortedPoints.map(point => point.amount)));

    return uniqueAmounts.map(amount => {
      const point = { amount };
      dataSets.forEach(dataSet => {
        const matchingPoint = sortedPoints.find(p => p.amount === amount && p[dataSet.name] !== undefined);
        point[dataSet.name] = matchingPoint ? matchingPoint[dataSet.name] : null;
      });
      return point;
    });
  }, [dataSets]);

  const colors = ['#8884d8', '#82ca9d', '#ffc658'];

  return (
    <div className="p-4 max-w-6xl mx-auto">
      <h1 className="text-2xl font-bold mb-4">商品構成グラフ生成アプリ</h1>
      <div className="mb-4">
        <h2 className="text-xl font-semibold mb-2">データ入力</h2>
        {dataSets.map((dataSet, dataSetIndex) => (
          <div key={dataSetIndex} className="mb-6 p-4 border rounded">
            <div className="flex items-center mb-2">
              <input
                type="text"
                value={dataSet.name}
                onChange={(e) => handleDataSetNameChange(dataSetIndex, e.target.value)}
                className="text-lg font-medium border-b border-gray-300 focus:outline-none focus:border-blue-500 mr-2"
                placeholder={`店舗${dataSetIndex + 1}`}
              />
            </div>
            <div className="grid grid-cols-5 gap-4">
              {dataSet.data.map((point, pointIndex) => (
                <div key={pointIndex} className="flex flex-col space-y-2">
                  <input
                    type="number"
                    value={point.amount}
                    onChange={(e) => handleInputChange(dataSetIndex, pointIndex, 'amount', e.target.value)}
                    className="border border-gray-300 rounded px-2 py-1"
                    placeholder="金額"
                  />
                  <input
                    type="number"
                    value={point.faces}
                    onChange={(e) => handleInputChange(dataSetIndex, pointIndex, 'faces', e.target.value)}
                    className="border border-gray-300 rounded px-2 py-1"
                    placeholder="フェース数"
                  />
                </div>
              ))}
            </div>
          </div>
        ))}
      </div>
      <div className="mb-4">
        <h2 className="text-xl font-semibold mb-2">商品構成グラフ</h2>
        <ResponsiveContainer width="100%" height={400}>
          <LineChart data={processedData}>
            <CartesianGrid strokeDasharray="3 3" />
            <XAxis 
              dataKey="amount" 
              type="number" 
              label={{ value: '金額', position: 'insideBottomRight', offset: -10 }} 
            />
            <YAxis 
              label={{ value: 'フェース数', angle: -90, position: 'insideLeft' }} 
            />
            <Tooltip />
            <Legend />
            {dataSets.map((dataSet, index) => (
              <Line 
                key={dataSet.name}
                type="linear"
                dataKey={dataSet.name} 
                stroke={colors[index]} 
                activeDot={{ r: 8 }} 
                connectNulls={true}
              />
            ))}
          </LineChart>
        </ResponsiveContainer>
      </div>
    </div>
  );
};

export default ProductCompositionChart;
